# File: azure-pipelines.yml

resources:
  repositories:
  - repository: datagrid-web-tests
    type: github
    name: OutSystems/datagrid-web-tests
    endpoint: OutSystems

trigger:
  branches:
    include:
    - dev
variables:
  SourcesDirectory: '$(Build.SourcesDirectory)'
  Project: 'outsystems-datagrid-reactive'
  BuildConfiguration: 'Release'
  Config: '--configuration=$(BuildConfiguration)'
  TagName: 'v$(Build.BuildNumber)'
  CurrentBranchName: $(Build.SourceBranchName)
  SourceBranchName: $(System.PullRequest.SourceBranch)
  
stages: 
- stage: Build
  displayName: 'Build'
  jobs:
  - job: SourceBranch
    steps:
    - script: echo $(CurrentBranchName)
  - job: BranchName
    steps:
    - script: echo $(SourceBranchName)

  - job: Build
    displayName: 'Build Job'
    timeoutInMinutes: 8
    pool:
      vmImage: 'windows-latest'
    steps:

    #Checkout repositories
    - checkout: self
    - checkout: datagrid-web-tests

    #Install dependencies
    - task: Npm@1
      displayName: 'npm install'
      inputs:
        workingDir: './outsystems-datagrid-reactive/code'
        verbose: false

    #Compile typescript files
    - task: Npm@1
      displayName: 'npm run build'
      inputs:
        workingDir: './outsystems-datagrid-reactive/code'
        command: custom
        verbose: false
        customCommand: 'run build'

    #Publish compiled file    
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: './outsystems-datagrid-reactive/code/dist/GridFramework.js'
        ArtifactName: 'GridFramework.js'
        publishLocation: 'Container'

    #Publish css file
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: './outsystems-datagrid-reactive/code/styles/Grid.css'
        ArtifactName: 'Grid.css'
        publishLocation: 'Container'

#Run test pipeline
- template: 'jobs/azure-pipelines-reactive.yml'
  parameters:
    currentBranch: $(CurrentBranchName)
    sourceBranch: $(SourceBranchName)